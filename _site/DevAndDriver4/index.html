<!DOCTYPE html>
<html>
<head>
    <!--
    * Author:         BeiYuu
    -->
    <meta charset="utf-8" />
    <title>Linux设备驱动模型及其他(4) | maxwellxxx's Blog</title>
    <meta name="author" content="MaxWellxxx" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="MaxWellxxx's Blog" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>

    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">MaxWellxxx</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/u/1863312387" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<link href="/assets/themes/fancyBox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 1000px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/DevAndDriver4" title="Linux设备驱动模型及其他(4)">Linux设备驱动模型及其他(4)</a></h1>
        <p class="entry-date">2015-07-30</p>
        <blockquote><p>上章讲到Linux写PCI设备枚举和配置的准备工作。</p></blockquote>

<h2>PCI子系统初始化（PCI设备枚举和设置）</h2>

<p>完成了准备工作，接下来就是正式的枚举总线以及设备了，但是具体从哪里开始，还得寻找下。它其实是在pci子系统初始化的时候才真正开始工作的：</p>

<pre><code> arch/x86/pci/legacy.c
 57 int __init pci_subsys_init(void)
 58 {
 59     /*
 60      * The init function returns an non zero value when
 61      * pci_legacy_init should be invoked.
 62      */
 63     if (x86_init.pci.init()) 
 64         pci_legacy_init();
 65
 66     pcibios_fixup_peer_bridges();
 67     x86_init.pci.init_irq();
 68     pcibios_init();
 69
 70     return 0;
 71 }
 72 subsys_initcall(pci_subsys_init);
</code></pre>

<p>相对于我们熟悉的arch_initcall，这里是subsys_initcall，从上一篇提供链接的博客可以知道，subsys_initcall的级别是低于arch_initcall的，这也印证了我们分析的流程是对的————先做了准备工作才进行这里正式的工作。那就一点一点来吧！首先是pci_legacy_init()：</p>

<pre><code>pci_legacy_init()（legacy.c）
   |
   |
   |
   pcibios_scan_root（arch/x86/pci/common.c）
****************************************************
475 void pcibios_scan_root(int busnum)
476 {   
477     struct pci_bus *bus;
478     struct pci_sysdata *sd;
479     LIST_HEAD(resources);
480     
481     sd = kzalloc(sizeof(*sd), GFP_KERNEL);
482     if (!sd) {
483         printk(KERN_ERR "PCI: OOM, skipping PCI bus %02x\n", busnum);
484         return;
485     }
486     sd-&gt;node = x86_pci_root_bus_node(busnum);
487     x86_pci_root_bus_resources(busnum, &amp;resources);
488     printk(KERN_DEBUG "PCI: Probing PCI hardware (bus %02x)\n", busnum);
489     bus = pci_scan_root_bus(NULL, busnum, &amp;pci_root_ops, sd, &amp;resources);
490     if (!bus) {
491         pci_free_resource_list(&amp;resources);
492         kfree(sd);
493     } 
494 } 
</code></pre>

<h2>参考目录</h2>

<p>[1]《Linux内核情景分析》[中]毛德操等 [著]</p>

<p>[2]《深入Linux内核架构》[德]Wolfgang Mauerer 著 [中]郭旭 译</p>

<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="Linux设备驱动模型及其他(4)" data-title="Linux设备驱动模型及其他(4)" data-url="/DevAndDriver4"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"maxwellxxx"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
    </div>

    <div class="sidenav">
        <iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=75&fansRow=2&ptype=1&speed=0&skin=5&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=1863312387&verifier=996dff3a&dpc=1"></iframe>
    </div>

    <div class="sidenav">
        <h2>Blog</h2>
        <ul class="artical-list">
        
            <li><a href="/buildcm">编译完整CM至HTC ONE（m7 gsm）</a></li>
        
            <li><a href="/AOSP">2015年第一发，不FQ下AOSP(为了百度TAG:Android源代码国内镜像)</a></li>
        
            <li><a href="/pinglun">这下大家满足了吧</a></li>
        
            <li><a href="/yougan">我是喷子</a></li>
        
            <li><a href="/newstory">新的故事</a></li>
        
        </ul>

        <h2>My Manual</h2>
        <ul class="artical-list">
        
            <li><a href="/DevAndDriver4">Linux设备驱动模型及其他(4)</a></li>
        
            <li><a href="/DevAndDriver3">Linux设备驱动模型及其他(3)</a></li>
        
            <li><a href="/DevAndDriver2">Linux设备驱动模型及其他(2)</a></li>
        
            <li><a href="/DevAndDriver1">Linux设备驱动模型及其他(1)</a></li>
        
            <li><a href="/linuxmemblock">Linux内核初期内存管理---memblock</a></li>
        
            <li><a href="/linuxearlymemory">Linux内核初始化阶段内存管理的几种阶段(1)</a></li>
        
            <li><a href="/linuxmemory">Linux高端内存映射等等</a></li>
        
            <li><a href="/linuxmemmanage">Linux初始化阶段内存管理框架初始化</a></li>
        
            <li><a href="/Linux-File">Linux文件I/O、系统基础编程总结</a></li>
        
            <li><a href="/Linux-Unix">Linux/Unix系统编程</a></li>
        
        </ul>

        <h2>Project</h2>
        <ul class="artical-list">
        
            <li><a href="/linux-swap">扩展Ubuntu Swap分区</a></li>
        
            <li><a href="/tinyos-ana">Tinyos概要分析</a></li>
        
            <li><a href="/tinyos">Ubuntu 下Tinyos开发环境的搭建</a></li>
        
            <li><a href="/github-pages">使用Github Pages建独立博客</a></li>
        
        </ul>
    </div>
</div>
  
<script src="/js/post.js" type="text/javascript"></script>
<script type="text/javascript" src="/assets/themes/fancyBox/jquery.fancybox.pack.js?v=2.1.5"></script>
<script>
// 给图片添加链接
$(document).ready(function() {
  $("p img").each(function() {
    var strA = "<a id='yourid' href='" + this.src + "'></a>";
    $(this).wrapAll(strA);
  });
});

// fancybox
$("#yourid").fancybox({
  openEffect    : 'elastic',
  closeEffect   : 'elastic',
});
</script>



    <script type="text/javascript">
        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })
    </script>
</body>
</html>
